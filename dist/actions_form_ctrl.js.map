{"version":3,"sources":["../src/actions_form_ctrl.js"],"names":["showActionForm","productionLine","orderId","description","productId","tags","getRowData","callback","result","postgres","getOrderStates","ok","orderStates","data","utils","alert","error","rowData","order_state","toLowerCase","appEvents","emit","src","modalClass","model","removeListeners","addListeners","url","getInfluxLine","get","then","formatData","res","catch","console","log","e","influxHost","records","series","results","cols","columns","map","x","substring","length","rows","resultTags","i","push","values","row","obj","k","col","Object","assign","allRecords","currents","filter","record","order_id","product_id","product_desc","current","isStateCheckOK","to","conflict","from","fromStates","state","toStates","toState","fromState","options","state_options","index","indexOf","is_unique","conflicts","backup_state","$","document","on","target","id","prepareUpdate","cons","STATE_FLAG","STATE_START","planned_rate","STATE_PAUSE","STATE_COMPLETE","STATE_CLOSE","rate","updateRecord","off","line","writeInfluxLine","conflictLine","conflictToState","confirm","ConfirmCtrl","tableCtrl","sendCamundaQACheck","show","sure","post","showAlerts","getProductById","camunda","startQACheck","production_line","closeForm","refresh","status","split","join","compl_qty","undefined","machine_state","scrap_qty","actual_start_datetime","actual_end_datetime","moment","now","order_date","order_qty","scheduled_end_datetime","scheduled_start_datetime","planned_changeover_time","runningRecord","trigger"],"mappings":"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","file":"actions_form_ctrl.js","sourcesContent":["\nimport { appEvents } from 'app/core/core'\nimport { get, influxHost, post, alert } from './utils'\nimport * as tableCtrl from './table_ctrl'\nimport { ConfirmCtrl } from './confirm_modal_ctrl'\nimport * as postgres from './postgres'\nimport * as camunda from './camunda'\nimport * as utils from './utils'\nimport * as cons from './constants'\nimport moment from 'moment'\n\nlet rowData\nlet runningRecord = {}\nlet orderStates = {}\nlet allRecords = []\n\nconst closeForm = () => {\n  $('#order-mgt-operator-action-form-dismiss-btn').trigger('click')\n}\n\nfunction showActionForm(productionLine, orderId, description, productId) {\n  const tags = {\n    productionLine : productionLine, \n    orderId : orderId,\n    description : description,\n    productId : productId\n  }\n\n  getRowData(callback, tags)\n\n  async function callback() {\n    const result = await postgres.getOrderStates()\n    if (result.ok) {\n      orderStates = result.data\n    }else {\n      utils.alert('error', 'Connection Error', `Cannot get Order States from Postgres database due to ${result.error}, please try again or contact the dev team`)\n      return\n    }\n    if (rowData.order_state) {\n      if (rowData.order_state.toLowerCase() === 'planned') {\n        alert('warning', 'Warning', 'This order has NOT been released')\n        return\n      }\n      if (rowData.order_state.toLowerCase() === 'closed') {\n        alert('warning', 'Warning', 'This order has been closed')\n        return\n      }\n    }\n\n    appEvents.emit('show-modal', {\n      src: 'public/plugins/smart-factory-operator-order-mgt-table-panel/partials/actions_form.html',\n      modalClass: 'confirm-modal',\n      model: { orderId : tags.orderId }\n    })\n\n    removeListeners()\n    addListeners()\n  }\n\n}\n\n/**\n * Get the record data with the tag values passed in\n * Call the callback function once it is finished\n * Stop and prompt error when it fails\n * @param {*} callback \n * @param {*} tags \n */\nfunction getRowData(callback, tags){\n  const url = getInfluxLine(tags)\n  get(url).then(res => {\n    const result = formatData(res, tags)\n    rowData = result\n    callback()\n  }).catch(e => {\n    alert('error', 'Database Error', 'Database connection failed with influxdb')\n    console.log(e)\n  })\n}\n\n/**\n * Write line for the influxdb query\n * @param {*} tags \n */\nfunction getInfluxLine(tags){\n  let url = influxHost + 'query?pretty=true&db=smart_factory&q=select last(*) from OrderPerformance' + ' where '\n  url += 'production_line=' + '\\'' + tags.productionLine + '\\'' + ' group by ' + '\"product_desc\", \"product_id\", \"order_id\"'\n\n  // console.log(url)\n  \n  return url\n}\n\n/**\n * The params may contain more than one row record\n * This is to fomrat the http response into a better structure\n * And also filter out the latest record\n * @param {*} res \n */\nfunction formatData(res, tags){\n  let records = []\n\n  const series = res.results[0].series\n\n  let cols = series[0].columns\n  cols = cols.map(x => x.substring(5, x.length))\n  cols[0] = \"time\"\n  let rows = []\n  let resultTags = []\n  for (let i = 0; i < series.length; i++) {\n    rows.push(series[i].values[0])\n    resultTags.push(series[i].tags)\n  }\n\n  for (let i = 0; i < rows.length; i++) {\n    const row = rows[i];\n    let obj = {}\n    for (let k = 0; k < cols.length; k++) {\n      const col = cols[k];\n      obj[col] = row[k]\n    }\n    obj = Object.assign(obj, resultTags[i])\n    records.push(obj)\n  }\n  \n  allRecords = records\n  const currents = records.filter(record => record.order_id === tags.orderId && record.product_id === tags.productId && record.product_desc === tags.description)\n  const current = currents[currents.length - 1]\n\n  return current\n}\n\nfunction isStateCheckOK(rowData, to) {\n  let conflict = null\n  const from = rowData.order_state\n  const fromStates = orderStates.filter(x => x.state === from.toLowerCase())\n  const toStates = orderStates.filter(x => x.state === to.toLowerCase())\n\n  if (fromStates.length === 0) {\n    utils.alert('warning', 'Warning', `State ${from} not found from the config table in postgresdb, please finish order state configuration first`)\n    return false\n  }else if (toStates.length === 0) {\n    utils.alert('warning', 'Warning', `State ${to} not found from the config table in postgresdb, please finish order state configuration first`)\n    return false\n  }\n\n  const toState = toStates[0]\n  const fromState = fromStates[0]\n  const options = fromState.state_options\n  const index = options.indexOf(to.toLowerCase())\n  if (!~index) {\n    utils.alert('warning', 'Warning', `You can not change state from <${from.toLowerCase()}> to <${to}>`)\n    return false\n  }\n\n  if (toState.is_unique) {\n    const conflicts = allRecords.filter(x => x.order_state.toLowerCase() === toState.state.toLowerCase())\n    if (conflicts.length !== 0) {\n      conflict = conflicts[0]\n      conflict.toState = toState.backup_state\n    }\n  }\n\n  return [true, conflict]\n}\n\n/**\n * Add listener for the action selection\n * If edit clicked, go to the edit form with the current record data\n * If realease clicked, change record status to 'Ready'\n * If delete clicked, change record status to 'Deleted'\n */\nfunction addListeners() {\n  $(document).on('click', 'input[type=\"button\"][name=\"order-mgt-operator-actions-radio\"]', e => {\n\n    if (e.target.id === 'flag') {\n      prepareUpdate(cons.STATE_FLAG, 0)\n    }else if (e.target.id === 'start') {\n      prepareUpdate(cons.STATE_START, rowData.planned_rate)\n    }else if (e.target.id === 'pause') {\n      prepareUpdate(cons.STATE_PAUSE, 0)\n    }else if (e.target.id === 'complete') {\n      prepareUpdate(cons.STATE_COMPLETE, 0)\n    }else if (e.target.id === 'close') {\n      prepareUpdate(cons.STATE_CLOSE, 0)\n    }\n\n  })\n\n}\n\nfunction prepareUpdate(state, rate) {\n  const result = isStateCheckOK(rowData, state)\n  const ok = result[0]\n  const conflict = result[1]\n  if(ok){ updateRecord(rowData, conflict, state, rate) }\n}\n\nfunction removeListeners() {\n  $(document).off('click', 'input[type=\"button\"][name=\"order-mgt-operator-actions-radio\"]')\n}\n\nasync function updateRecord(data, conflict, toState, rate){\n\n  const fromState = data.order_state.toLowerCase()\n  const line = writeInfluxLine(data, toState, rate)\n  const url = influxHost + 'write?db=smart_factory'\n\n  if(conflict) {\n    const conflictLine = writeInfluxLine(conflict, conflict.toState || fromState, 0)\n    const conflictToState = conflict.toState || fromState\n    const confirm = new ConfirmCtrl({tableCtrl, data, conflict, conflictToState, toState, line, conflictLine, url, sendCamundaQACheck})\n    confirm.show()\n  }else {\n    const result = await utils.sure(utils.post(url, line))\n    showAlerts(result, data.order_id, toState)\n    if(toState.toLowerCase() === cons.STATE_START.toLowerCase()){\n      sendCamundaQACheck(data)\n    }\n  }\n\n}\n\nfunction sendCamundaQACheck(data) {\n  postgres.getProductById(data.product_id, res => {\n    if (res.length === 0) {\n      utils.alert('error', 'Product Not Found', 'Camunda QA Check process initialisation failed because this Product CANNOT be found in the database, it may be because the product definition has been changed, but you can still start it Manually in Camunda BPM')\n    }else {\n      camunda.startQACheck(res[0], data.production_line)\n    }\n  })\n}\n\nfunction showAlerts(result, id, state) {\n  if (result.ok) {\n    alert('success', 'Success', `Order ${id} has been marked as ${state}`)\n    closeForm()\n    tableCtrl.refresh()\n  }else {\n    alert('error', 'Error', `An error occurred while updating the database due to ${result.error}, please try again or contact the dev team`)\n    closeForm()\n    console.log(result.error)\n  }\n}\n\n/**\n * Expect the status string (Normally are: 'Ready' or 'Deleted')\n * Then changed the status in the line with anything else unchanged\n * @param {*} status \n */\nfunction writeInfluxLine(data, status, rate){\n  //For influxdb tag keys, must add a forward slash \\ before each space \n  let product_desc = data.product_desc.split(' ').join('\\\\ ')\n\n  let line = 'OrderPerformance,order_id=' + data.order_id + ',product_id=' + data.product_id + ',product_desc=' + product_desc + ' '\n\n  if (data.compl_qty !== null && data.compl_qty !== undefined) {\n    line += 'compl_qty=' + data.compl_qty + ','\n  }\n  if (data.machine_state !== null && data.machine_state !== undefined) {\n    line += 'machine_state=\"' + data.machine_state + '\"' + ','\n  }\n  if (data.scrap_qty !== null && data.scrap_qty !== undefined) {\n    line += 'scrap_qty=' + data.scrap_qty + ','\n  }\n  if (data.actual_start_datetime !== null && data.actual_start_datetime !== undefined) {\n    line += 'actual_start_datetime=' + data.actual_start_datetime + ','\n  }\n  if (data.actual_end_datetime !== null && data.actual_end_datetime !== undefined) {\n    line += 'actual_end_datetime=' + data.actual_end_datetime + ','\n  }\n\n  if (status === cons.STATE_START && (data.actual_start_datetime === null || data.actual_start_datetime === undefined)) {\n    //set actual start time = now if there is no actual\n    //but do nothing if there is acutal start time, meaning that it was paused and start again\n    line += 'actual_start_datetime=' + moment.now() + ','\n  }else if(status === cons.STATE_COMPLETE){\n    //set actual end time = now\n    line += 'actual_end_datetime=' + moment.now() + ','\n  }\n\n  line += 'order_state=\"' + status + '\"' + ','\n  line += 'order_date=\"' + data.order_date + '\"' + ','\n  line += 'production_line=\"' + data.production_line + '\"' + ','\n  line += 'order_qty=' + data.order_qty + ','\n  line += 'scheduled_end_datetime=' + data.scheduled_end_datetime + ','\n  line += 'scheduled_start_datetime=' + data.scheduled_start_datetime + ','\n  line += 'planned_changeover_time=\"' + data.planned_changeover_time + '\"' + ','\n  line += 'setpoint_rate=' + rate + ','\n  line += 'planned_rate=' + data.planned_rate\n\n  // console.log(line);\n  return line\n}\n\nexport { showActionForm }"]}