{"version":3,"sources":["../src/actions_form_ctrl.js"],"names":["showActionForm","productionLine","orderId","description","productId","tags","getRowData","callback","result","postgres","getOrderStates","ok","orderStates","data","utils","alert","error","rowData","order_state","toLowerCase","cons","STATE_PLAN","STATE_CLOSE","appEvents","emit","src","modalClass","model","removeListeners","addListeners","url","getInfluxLine","get","then","res","formatData","catch","e","console","log","influxHost","records","series","results","cols","columns","map","x","substring","length","rows","resultTags","i","push","values","row","obj","k","col","Object","assign","allRecords","currents","filter","record","order_id","product_id","product_desc","current","isStateCheckOK","to","conflict","from","fromStates","state","toStates","toState","fromState","options","state_options","index","indexOf","is_unique","conflicts","backup_state","$","document","on","target","id","prepareUpdate","STATE_FLAG","STATE_START","planned_rate","STATE_PAUSE","STATE_COMPLETE","rate","updateRecord","off","line","writeInfluxLine","conflictLine","conflictToState","confirm","ConfirmCtrl","tableCtrl","sendCamundaQACheck","show","completeConfirm","CompleteConfirmCtrl","showAlerts","sure","post","getProductById","camunda","startQACheck","production_line","closeForm","refresh","status","compl_qty","undefined","machine_state","getRid","scrap_qty","actual_start_datetime","actual_end_datetime","moment","now","order_date","order_qty","scheduled_end_datetime","scheduled_start_datetime","planned_changeover_time","split","join","runningRecord","trigger"],"mappings":"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","file":"actions_form_ctrl.js","sourcesContent":["import { appEvents } from 'app/core/core';\nimport { get, influxHost, post, alert } from './utils';\nimport * as tableCtrl from './table_ctrl';\nimport { ConfirmCtrl } from './confirm_modal_ctrl';\nimport { CompleteConfirmCtrl } from './confirm_modal_complete_ctrl';\nimport * as postgres from './postgres';\nimport * as camunda from './camunda';\nimport * as utils from './utils';\nimport * as cons from './constants';\nimport moment from 'moment';\n\nlet rowData;\nlet runningRecord = {};\nlet orderStates = {};\nlet allRecords = [];\n\nconst closeForm = () => {\n\t$('#order-mgt-operator-action-form-dismiss-btn').trigger('click');\n};\n\nfunction showActionForm(productionLine, orderId, description, productId) {\n\tconst tags = {\n\t\tproductionLine: productionLine,\n\t\torderId: orderId,\n\t\tdescription: description,\n\t\tproductId: productId\n\t};\n\n\tgetRowData(callback, tags);\n\n\tasync function callback() {\n\t\tconst result = await postgres.getOrderStates();\n\t\tif (result.ok) {\n\t\t\torderStates = result.data;\n\t\t} else {\n\t\t\tutils.alert(\n\t\t\t\t'error',\n\t\t\t\t'Connection Error',\n\t\t\t\t`Cannot get Order States from Postgres database due to ${result.error}, please try again or contact the dev team`\n\t\t\t);\n\t\t\treturn;\n\t\t}\n\t\tif (rowData.order_state) {\n\t\t\tif (rowData.order_state.toLowerCase() === cons.STATE_PLAN.toLowerCase()) {\n\t\t\t\talert('warning', 'Warning', 'This order has NOT been released');\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (rowData.order_state.toLowerCase() === cons.STATE_CLOSE.toLowerCase()) {\n\t\t\t\talert('warning', 'Warning', 'This order has been closed');\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tappEvents.emit('show-modal', {\n\t\t\tsrc: 'public/plugins/smart-factory-operator-order-mgt-table-panel/partials/actions_form.html',\n\t\t\tmodalClass: 'confirm-modal',\n\t\t\tmodel: { orderId: tags.orderId }\n\t\t});\n\n\t\tremoveListeners();\n\t\taddListeners();\n\t}\n}\n\n/**\n * Get the record data with the tag values passed in\n * Call the callback function once it is finished\n * Stop and prompt error when it fails\n * @param {*} callback \n * @param {*} tags \n */\nfunction getRowData(callback, tags) {\n\tconst url = getInfluxLine(tags);\n\tget(url)\n\t\t.then((res) => {\n\t\t\tconst result = formatData(res, tags);\n\t\t\trowData = result;\n\t\t\tcallback();\n\t\t})\n\t\t.catch((e) => {\n\t\t\talert('error', 'Database Error', 'Database connection failed with influxdb');\n\t\t\tconsole.log(e);\n\t\t});\n}\n\n/**\n * Write line for the influxdb query\n * @param {*} tags \n */\nfunction getInfluxLine(tags) {\n\tlet url = influxHost + 'query?pretty=true&db=smart_factory&q=select last(*) from OrderPerformance' + ' where ';\n\turl += 'production_line=' + \"'\" + tags.productionLine + \"'\" + ' group by ' + '\"product_id\", \"order_id\"';\n\n\t// console.log(url)\n\n\treturn url;\n}\n\n/**\n * The params may contain more than one row record\n * This is to fomrat the http response into a better structure\n * And also filter out the latest record\n * @param {*} res \n */\nfunction formatData(res, tags) {\n\tlet records = [];\n\n\tconst series = res.results[0].series;\n\n\tlet cols = series[0].columns;\n\tcols = cols.map((x) => x.substring(5, x.length));\n\tcols[0] = 'time';\n\tlet rows = [];\n\tlet resultTags = [];\n\tfor (let i = 0; i < series.length; i++) {\n\t\trows.push(series[i].values[0]);\n\t\tresultTags.push(series[i].tags);\n\t}\n\n\tfor (let i = 0; i < rows.length; i++) {\n\t\tconst row = rows[i];\n\t\tlet obj = {};\n\t\tfor (let k = 0; k < cols.length; k++) {\n\t\t\tconst col = cols[k];\n\t\t\tobj[col] = row[k];\n\t\t}\n\t\tobj = Object.assign(obj, resultTags[i]);\n\t\trecords.push(obj);\n\t}\n\n\tallRecords = records;\n\tconst currents = records.filter(\n\t\t(record) =>\n\t\t\trecord.order_id === tags.orderId &&\n\t\t\trecord.product_id === tags.productId &&\n\t\t\trecord.product_desc === tags.description\n\t);\n\tconst current = currents[currents.length - 1];\n\n\treturn current;\n}\n\nfunction isStateCheckOK(rowData, to) {\n\tlet conflict = null;\n\tconst from = rowData.order_state;\n\tconst fromStates = orderStates.filter((x) => x.state === from.toLowerCase());\n\tconst toStates = orderStates.filter((x) => x.state === to.toLowerCase());\n\n\tif (fromStates.length === 0) {\n\t\tutils.alert(\n\t\t\t'warning',\n\t\t\t'Warning',\n\t\t\t`State ${from} not found from the config table in postgresdb, please finish order state configuration first`\n\t\t);\n\t\treturn false;\n\t} else if (toStates.length === 0) {\n\t\tutils.alert(\n\t\t\t'warning',\n\t\t\t'Warning',\n\t\t\t`State ${to} not found from the config table in postgresdb, please finish order state configuration first`\n\t\t);\n\t\treturn false;\n\t}\n\n\tconst toState = toStates[0];\n\tconst fromState = fromStates[0];\n\tconst options = fromState.state_options;\n\tconst index = options.indexOf(to.toLowerCase());\n\tif (!~index) {\n\t\tutils.alert('warning', 'Warning', `You can not change state from <${from.toLowerCase()}> to <${to}>`);\n\t\treturn false;\n\t}\n\n\tif (toState.is_unique) {\n\t\tconst conflicts = allRecords.filter((x) => x.order_state.toLowerCase() === toState.state.toLowerCase());\n\t\tif (conflicts.length !== 0) {\n\t\t\tconflict = conflicts[0];\n\t\t\tconflict.toState = toState.backup_state;\n\t\t}\n\t}\n\n\treturn [ true, conflict ];\n}\n\n/**\n * Add listener for the action selection\n * If edit clicked, go to the edit form with the current record data\n * If realease clicked, change record status to 'Ready'\n * If delete clicked, change record status to 'Deleted'\n */\nfunction addListeners() {\n\t$(document).on('click', 'input[type=\"button\"][name=\"order-mgt-operator-actions-radio\"]', (e) => {\n\t\tif (e.target.id === 'flag') {\n\t\t\tprepareUpdate(cons.STATE_FLAG, 0);\n\t\t} else if (e.target.id === 'start') {\n\t\t\tprepareUpdate(cons.STATE_START, rowData.planned_rate);\n\t\t} else if (e.target.id === 'pause') {\n\t\t\tprepareUpdate(cons.STATE_PAUSE, 0);\n\t\t} else if (e.target.id === 'complete') {\n\t\t\tprepareUpdate(cons.STATE_COMPLETE, 0);\n\t\t} else if (e.target.id === 'close') {\n\t\t\tprepareUpdate(cons.STATE_CLOSE, 0);\n\t\t}\n\t});\n}\n\nfunction prepareUpdate(state, rate) {\n\tconst result = isStateCheckOK(rowData, state);\n\tconst ok = result[0];\n\tconst conflict = result[1];\n\tif (ok) {\n\t\tupdateRecord(rowData, conflict, state, rate);\n\t}\n}\n\nfunction removeListeners() {\n\t$(document).off('click', 'input[type=\"button\"][name=\"order-mgt-operator-actions-radio\"]');\n}\n\nasync function updateRecord(data, conflict, toState, rate) {\n\tconst fromState = data.order_state.toLowerCase();\n\tconst line = writeInfluxLine(data, toState, rate);\n\tconst url = influxHost + 'write?db=smart_factory';\n\n\tif (conflict) {\n\t\tconst conflictLine = writeInfluxLine(conflict, conflict.toState || fromState, 0);\n\t\tconst conflictToState = conflict.toState || fromState;\n\t\tconst confirm = new ConfirmCtrl({\n\t\t\ttableCtrl,\n\t\t\tdata,\n\t\t\tconflict,\n\t\t\tconflictToState,\n\t\t\ttoState,\n\t\t\tline,\n\t\t\tconflictLine,\n\t\t\turl,\n\t\t\tsendCamundaQACheck\n\t\t});\n\t\tconfirm.show();\n\t} else {\n\t\t// no conflict\n\t\tif (toState.toLowerCase() === cons.STATE_COMPLETE.toLowerCase()) {\n\t\t\t// if is to complete\n\t\t\tconst completeConfirm = new CompleteConfirmCtrl({\n\t\t\t\ttableCtrl,\n\t\t\t\tdata,\n\t\t\t\turl,\n\t\t\t\tline,\n\t\t\t\tshowAlerts\n\t\t\t});\n\t\t\tcompleteConfirm.show();\n\t\t} else {\n\t\t\tconst result = await utils.sure(utils.post(url, line));\n\t\t\tshowAlerts(result, data.order_id, toState);\n\t\t\tif (toState.toLowerCase() === cons.STATE_START.toLowerCase()) {\n\t\t\t\tsendCamundaQACheck(data);\n\t\t\t}\n\t\t}\n\t}\n}\n\nfunction sendCamundaQACheck(data) {\n\tpostgres.getProductById(data.product_id, (res) => {\n\t\tif (res.length === 0) {\n\t\t\tutils.alert(\n\t\t\t\t'error',\n\t\t\t\t'Product Not Found',\n\t\t\t\t'Camunda QA Check process initialisation failed because this Product CANNOT be found in the database, it may be because the product definition has been changed, but you can still start it Manually in Camunda BPM'\n\t\t\t);\n\t\t} else {\n\t\t\tcamunda.startQACheck(res[0], data.production_line, data.order_id);\n\t\t}\n\t});\n}\n\nfunction showAlerts(result, id, state) {\n\tif (result.ok) {\n\t\talert('success', 'Success', `Order ${id} has been marked as ${state}`);\n\t\tcloseForm();\n\t\ttableCtrl.refresh();\n\t} else {\n\t\talert(\n\t\t\t'error',\n\t\t\t'Error',\n\t\t\t`An error occurred while updating the database due to ${result.error}, please try again or contact the dev team`\n\t\t);\n\t\tcloseForm();\n\t\tconsole.log(result.error);\n\t}\n}\n\n/**\n * Expect the status string (Normally are: 'Ready' or 'Deleted')\n * Then changed the status in the line with anything else unchanged\n * @param {*} status \n */\nfunction writeInfluxLine(data, status, rate) {\n\t//For influxdb tag keys, must add a forward slash \\ before each space\n\t// let product_desc = data.product_desc.split(' ').join('\\\\ ')\n\n\tlet line = 'OrderPerformance,order_id=' + data.order_id + ',product_id=' + data.product_id + ' ';\n\n\tif (data.compl_qty !== null && data.compl_qty !== undefined) {\n\t\tline += 'compl_qty=' + data.compl_qty + ',';\n\t}\n\tif (data.machine_state !== null && data.machine_state !== undefined) {\n\t\tline += 'machine_state=\"' + getRid(data.machine_state) + '\"' + ',';\n\t}\n\tif (data.scrap_qty !== null && data.scrap_qty !== undefined) {\n\t\tline += 'scrap_qty=' + data.scrap_qty + ',';\n\t}\n\tif (data.actual_start_datetime !== null && data.actual_start_datetime !== undefined) {\n\t\tline += 'actual_start_datetime=' + data.actual_start_datetime + ',';\n\t}\n\tif (data.actual_end_datetime !== null && data.actual_end_datetime !== undefined) {\n\t\tline += 'actual_end_datetime=' + data.actual_end_datetime + ',';\n\t}\n\n\tif (\n\t\tstatus === cons.STATE_START &&\n\t\t(data.actual_start_datetime === null || data.actual_start_datetime === undefined)\n\t) {\n\t\t//set actual start time = now if there is no actual\n\t\t//but do nothing if there is acutal start time, meaning that it was paused and start again\n\t\tline += 'actual_start_datetime=' + moment.now() + ',';\n\t} else if (status === cons.STATE_COMPLETE) {\n\t\t//set actual end time = now\n\t\tline += 'actual_end_datetime=' + moment.now() + ',';\n\t}\n\n\tline += 'order_state=\"' + getRid(status) + '\"' + ',';\n\tline += 'product_desc=\"' + getRid(data.product_desc) + '\"' + ',';\n\tline += 'order_date=\"' + data.order_date + '\"' + ',';\n\tline += 'production_line=\"' + getRid(data.production_line) + '\"' + ',';\n\tline += 'order_qty=' + data.order_qty + ',';\n\tline += 'scheduled_end_datetime=' + data.scheduled_end_datetime + ',';\n\tline += 'scheduled_start_datetime=' + data.scheduled_start_datetime + ',';\n\tline += 'planned_changeover_time=\"' + data.planned_changeover_time + '\"' + ',';\n\tline += 'setpoint_rate=' + rate + ',';\n\tline += 'planned_rate=' + data.planned_rate;\n\n\t// console.log(line);\n\treturn line;\n}\n\nfunction getRid(x) {\n\treturn x.split('\"').join('\\\\\"');\n}\n\nexport { showActionForm };\n"]}